name: Test Terraform modules plan

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main
    paths:
      - "infra/modules/**"

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  ARM_USE_OIDC: true
  ARM_USE_AZUREAD: true
  ARM_STORAGE_USE_AZUREAD: true

jobs:
  get-modified-modules:
    uses: ./.github/workflows/get_modified_modules.yaml
    name: Get Modified Modules
    if: ${{ github.event_name != 'workflow_dispatch' }}

  get-all-modules:
    uses: ./.github/workflows/get_all_modules.yaml
    name: Get All Modules
    if: ${{ github.event_name == 'workflow_dispatch' }}

  terraform-test:
    runs-on: ubuntu-latest
    needs: [get-modified-modules, get-all-modules]
    if: always()
    environment: dev-ci
    permissions:
      id-token: write
      contents: read
    strategy:
      fail-fast: false
      matrix:
        module: ${{ fromJSON(needs.get-all-modules.outputs.modules || needs.get-modified-modules.outputs.modules) }}
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
    steps:

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: ./.github/actions/azure-login
        name: Azure Login

      - name: Terraform Setup and init
        id: set-terraform-version
        uses: ./.github/actions/terraform-setup
        with:
          working_dir: infra/modules/${{ matrix.module }}

      - name: Terraform Test
        working-directory: infra/modules/${{ matrix.module }}
        run: |
          set -euo

          terraform test
