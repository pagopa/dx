name: OpEx Dashboard Deploy

on:
  workflow_call:
    inputs:
      config_pattern:
        description: |
          Glob pattern(s) to find dashboard config files. Supports multiple patterns (one per line).
          Examples:
            Single: 'infra/dashboards/**/config.yaml'
            Multiple: |
              infra/dashboards/**/config.yaml
              .opex/**/config.yaml
        type: string
        required: true
      use_private_agent:
        description: Use a private agent to run Terraform operations
        type: boolean
        required: false
        default: false

env:
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  ARM_USE_OIDC: true
  ARM_USE_AZUREAD: true
  ARM_STORAGE_USE_AZUREAD: true
  OPEX_DASHBOARD_VERSION: "0.2.0"

concurrency:
  group: ${{ github.workflow }}-opex-dashboards
  cancel-in-progress: false

jobs:
  generate:
    name: Generate Dashboard Terraform
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_changes: ${{ steps.generate-action.outputs.has_changes }}
      changed_directories: ${{ steps.generate-action.outputs.changed_directories }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Check if running from fork
        env:
          IS_FORK: ${{ github.event.repository.fork }}
        run: |
          if [ "$IS_FORK" = "true" ]; then
            echo "::error::This workflow cannot be run from a forked repository"
            exit 1
          fi

      - name: Setup Node.js
        uses: pagopa/dx/.github/actions/node-setup@main

      - name: Validate inputs
        id: validate-inputs
        run: |
          # Validate event_name
          if [ -n "${EVENT_NAME}" ]; then
            if [[ "${EVENT_NAME}" =~ [^a-z_] ]]; then
              echo "::error::Invalid characters in event_name: ${EVENT_NAME}"
              echo "::error::event_name may only contain: lowercase letters and underscore"
              exit 1
            fi
          fi

          # Validate git references (event.before and pull_request.base.sha)
          for ref_name in "EVENT_BEFORE" "PR_BASE_SHA"; do
            ref_value="${!ref_name}"
            if [ -n "${ref_value}" ] && [ "${ref_value}" != "0000000000000000000000000000000000000000" ]; then
              if [[ ! "${ref_value}" =~ ^[a-f0-9]{40}$ ]] && [[ ! "${ref_value}" =~ ^[A-Za-z0-9/_^~.-]+$ ]]; then
                echo "::error::Invalid git reference in ${ref_name}: ${ref_value}"
                exit 1
              fi
            fi
          done

          echo "Input validation passed"
        env:
          EVENT_NAME: ${{ github.event_name }}
          EVENT_BEFORE: ${{ github.event.before }}
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}

      - name: Set base reference
        id: set-base-ref
        run: |
          BASE_REF=""

          # For pull requests, use base SHA
          if [ "${EVENT_NAME}" = "pull_request" ]; then
            BASE_REF="${PR_BASE_SHA}"
          # For push events, use event.before if valid
          elif [ -n "${EVENT_BEFORE}" ] && [ "${EVENT_BEFORE}" != "0000000000000000000000000000000000000000" ]; then
            BASE_REF="${EVENT_BEFORE}"
          # Fallback to HEAD~1 if possible
          elif git rev-parse HEAD~1 >/dev/null 2>&1; then
            BASE_REF="HEAD~1"
          # Last resort: use default branch
          else
            BASE_REF="origin/${DEFAULT_BRANCH}"
          fi

          echo "base_ref=${BASE_REF}" >> "${GITHUB_OUTPUT}"
          echo "Using base reference: ${BASE_REF}"
        env:
          EVENT_NAME: ${{ github.event_name }}
          EVENT_BEFORE: ${{ github.event.before }}
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}

      - name: Generate dashboards
        id: generate-action
        uses: pagopa/dx/actions/opex-dashboard-generate@chores/opex-workflow
        with:
          config_pattern: ${{ inputs.config_pattern }}
          opex_dashboard_version: ${{ env.OPEX_DASHBOARD_VERSION }}
          base_ref: ${{ steps.set-base-ref.outputs.base_ref }}

      - name: Collect generated files
        if: steps.generate-action.outputs.has_changes == 'true'
        env:
          CHANGED_DIRS_JSON: ${{ steps.generate-action.outputs.changed_directories }}
        run: |
          # Create collection directory
          mkdir -p .terraform-artifacts

          # Parse JSON and copy files from each changed directory
          echo "${CHANGED_DIRS_JSON}" | jq -r '.[].full_path' | while read -r dir; do
            if [ -d "$dir" ]; then
              echo "Collecting files from $dir"
              mkdir -p ".terraform-artifacts/$dir"
              # Copy generated Terraform files
              if ls "$dir"/*.tf 1> /dev/null 2>&1; then
                cp "$dir"/*.tf ".terraform-artifacts/$dir/"
              fi
              # Copy tfvars files if exist
              if ls "$dir"/*.tfvars 1> /dev/null 2>&1; then
                cp "$dir"/*.tfvars ".terraform-artifacts/$dir/"
              fi
              # Copy lock file if exists
              if [ -f "$dir/.terraform.lock.hcl" ]; then
                cp "$dir/.terraform.lock.hcl" ".terraform-artifacts/$dir/"
              fi
            fi
          done
          ls -R .terraform-artifacts

      - name: Upload generated Terraform files
        if: steps.generate-action.outputs.has_changes == 'true'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: generated-terraform
          path: .terraform-artifacts/
          include-hidden-files: true
          retention-days: 7

  tf_plan:
    name: Plan - ${{ matrix.dashboard.full_path }}
    needs: generate
    if: needs.generate.outputs.has_changes == 'true'
    runs-on: ${{ inputs.use_private_agent && 'self-hosted' || 'ubuntu-latest' }}
    environment: opex-${{ matrix.dashboard.environment }}-ci
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    strategy:
      matrix:
        dashboard: ${{ fromJson(needs.generate.outputs.changed_directories) }}
      fail-fast: false
      max-parallel: 5
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TFPLAN_FILE: tfplan-${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Download generated Terraform files
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: generated-terraform
          path: .

      - name: Cloud Login
        uses: pagopa/dx/actions/csp-login@main

      - name: Get terraform version from .terraform-version file
        id: get-version
        uses: pagopa/dx/.github/actions/get-terraform-version@main

      - name: Terraform Setup
        id: set-terraform-version
        uses: pagopa/dx/.github/actions/terraform-setup@main
        with:
          terraform_version: ${{ steps.get-version.outputs.terraform_version }}

      - name: Terraform Init
        working-directory: ${{ matrix.dashboard.full_path }}
        run: terraform init -input=false -backend-config=backend.tfvars

      - name: Generate artifact name
        id: artifact-name
        env:
          DASHBOARD_PATH: ${{ matrix.dashboard.full_path }}
          GIT_SHA: ${{ github.sha }}
        run: |
          # Create a safe artifact name from the dashboard path
          # Replace / and . with - to make it a valid artifact name
          SAFE_NAME=$(echo "${DASHBOARD_PATH}" | sed 's/[\/.:.]/-/g')
          ARTIFACT_NAME="tfplan-${SAFE_NAME}-${GIT_SHA}"
          echo "name=${ARTIFACT_NAME}" >> "$GITHUB_OUTPUT"
          echo "Generated artifact name: ${ARTIFACT_NAME}"

      - name: Terraform Plan
        id: plan
        working-directory: ${{ matrix.dashboard.full_path }}
        # We use lock=false since the -ci environment cannot write to the state backend
        run: |
          set -o pipefail
          terraform plan \
            -lock=false \
            -out="$TFPLAN_FILE" \
            -input=false \
            | tee plan_output.txt

          # Extract summary line
          SUMMARY=$(grep -E "Plan:|No changes" plan_output.txt | tail -1 || echo "Plan completed")
          echo "summary_line=$SUMMARY" >> "$GITHUB_OUTPUT"

      - name: Upload Terraform Plan
        uses: pagopa/dx/actions/terraform-plan-upload@main
        env:
          ARTIFACT_ENC_KEY: ${{ secrets.ARTIFACT_ENC_KEY }}
        with:
          plan-file: ${{ env.TFPLAN_FILE }}
          working-directory: ${{ matrix.dashboard.full_path }}
          artifact-name: ${{ steps.artifact-name.outputs.name }}
          retention-days: 1

      - name: Check Terraform Plan Result
        if: always() && steps.plan.outcome != 'success'
        run: exit 1

  tf_apply:
    name: Apply - ${{ matrix.dashboard.full_path }}
    needs: [generate, tf_plan]
    if: needs.generate.outputs.has_changes == 'true'
    runs-on: ${{ inputs.use_private_agent && 'self-hosted' || 'ubuntu-latest' }}
    environment: opex-${{ matrix.dashboard.environment }}-cd
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        dashboard: ${{ fromJson(needs.generate.outputs.changed_directories) }}
      fail-fast: false
      max-parallel: 5
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TFPLAN_FILE: tfplan-${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Generate artifact name
        id: artifact-name
        env:
          DASHBOARD_PATH: ${{ matrix.dashboard.full_path }}
          GIT_SHA: ${{ github.sha }}
        run: |
          # Create a safe artifact name from the dashboard path (same logic as in plan job)
          # Replace / and . with - to make it a valid artifact name
          SAFE_NAME=$(echo "${DASHBOARD_PATH}" | sed 's/[\/.:.]/-/g')
          ARTIFACT_NAME="tfplan-${SAFE_NAME}-${GIT_SHA}"
          echo "name=${ARTIFACT_NAME}" >> "$GITHUB_OUTPUT"
          echo "Generated artifact name: ${ARTIFACT_NAME}"

      - name: Download generated Terraform files
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: generated-terraform
          path: .

      - name: Download Terraform Plan
        uses: pagopa/dx/actions/terraform-plan-download@main
        env:
          ARTIFACT_ENC_KEY: ${{ secrets.ARTIFACT_ENC_KEY }}
        with:
          plan-file: tfplan-${{ github.sha }}
          working-directory: ${{ matrix.dashboard.full_path }}
          artifact-name: ${{ steps.artifact-name.outputs.name }}

      - name: Cloud Login
        uses: pagopa/dx/actions/csp-login@main

      - name: Get terraform version from .terraform-version file
        id: get-version
        uses: pagopa/dx/.github/actions/get-terraform-version@main

      - name: Terraform Setup
        id: set-terraform-version
        uses: pagopa/dx/.github/actions/terraform-setup@main
        with:
          terraform_version: ${{ steps.get-version.outputs.terraform_version }}

      - name: Terraform Init
        working-directory: ${{ matrix.dashboard.full_path }}
        run: terraform init -input=false -backend-config=backend.tfvars

      - name: Terraform Apply
        working-directory: ${{ matrix.dashboard.full_path }}
        run: |
          set -o pipefail
          terraform apply \
            -lock-timeout=120s \
            -auto-approve \
            -input=false \
            "$TFPLAN_FILE"
