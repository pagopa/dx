name: Deploy MCP Server
description: |
  Automated workflow to build MCP Server Docker image and deploy it to
  AWS Lambda when changes are made or new tags are pushed

on:
  workflow_dispatch:
  push:
    tags:
      - "@pagopa/dx-mcpserver@*"
    branches:
      - feat-action-for-mcp-deploy

jobs:
  build:
    name: Build MCP Docker Image
    runs-on: ubuntu-latest
    environment: infra-dev-ci # cd
    env:
      AWS_REGION: eu-central-1
      LAMBDA_FUNCTION_NAME: dx-p-euc1-mcp-server-lambda-01
      IMAGE_NAME: dx/mcp-server
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Cloud Login
        uses: pagopa/dx/actions/csp-login@feat-action-for-mcp-deploy # main

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2.0.1

      - name: Docker Build
        uses: pagopa/dx/.github/actions/docker-build-push@main
        with:
          dockerfile_path: "apps/mcpserver/Dockerfile"
          docker_image_name: "${{ env.IMAGE_NAME }}"
          docker_image_description: "DX MCP Server Docker Image"
          docker_image_authors: "PagoPA DX"
          build_platforms: linux/amd64
          push_to_registry: true

      - name: Get ECR image URI
        id: push-ecr
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_URI="$ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG"

          docker tag $IMAGE_URI
          docker push $IMAGE_URI

          echo "image-uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "âœ… Image URI: $IMAGE_URI"

      - name: Deploy Lambda
        uses: aws-actions/aws-lambda-deploy@29ea35c124579506cf0475e20df36198eb670d89 # v1.1.0
        with:
          function-name: ${{ env.LAMBDA_FUNCTION_NAME }}
          package-type: Image
          image-uri: ${{ steps.push-ecr.outputs.image-uri }}
