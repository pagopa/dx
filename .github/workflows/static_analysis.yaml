name: Terraform Analysis

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - "tf-validation"
  pull_request:
    types: [opened, synchronize]
    paths:
      - infra/**
      - .terraform-version
      - .pre-commit-config.yaml

jobs:
  tf_analysis:
    name: Terraform Validation
    runs-on: ubuntu-20.04
    env:
      TERRAFORM_VERSION: "1.7.5"
    container:
      image: ghcr.io/antonbabenko/pre-commit-terraform:v1.86.0@sha256:a1ffb8fff155934c1937580eeab8b3f68726485cd54025d2f911b0c21a9becba
    defaults:
      run:
        shell: bash

    steps:

      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
          # ref: ${{ github.sha }}

      # - name: Set Terraform Version
      #   id: set-terraform-version
      #   run: |
      #     set -eu
      #     terraform_version=$(cat .terraform-version)
      #     printf "terraform_version=$terraform_version" >> "$GITHUB_OUTPUT"

      # - uses: hashicorp/setup-terraform@a1502cd9e758c50496cc9ac5308c4843bcd56d36 # v3.0.0
      #   name: Setup Terraform
      #   with:
      #     terraform_version: ${{ steps.set-terraform-version.outputs.terraform_version }}

      - name: Git config
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Get changed files
        id: file_changes
        run: |
          export DIFF=$(git diff --name-only origin/${{ github.base_ref }} ${{ github.sha }})
          echo "Diff between ${{ github.base_ref }} and ${{ github.sha }}"
          echo "files=$( echo "$DIFF" | xargs echo )" >> $GITHUB_OUTPUT

      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-3|${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Run pre-commit
        run: |
          # set -eu

          pre-commit run \
            --color=always \
            --show-diff-on-failure \
            --files ${{ steps.file_changes.outputs.files }}
