name: Changelog

on:
  push:
    branches:
      - main
    paths:
      - .changeset/** # Only on changes to ./changeset/*

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  changelog:
    name: Update CHANGELOG
    runs-on: ubuntu-latest
    steps:
        - name: Checkout code
          uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
          with:
            # https://github.com/actions/checkout/issues/1471#issuecomment-1771231294
            fetch-tags: 'true'
            fetch-depth: 0

        # Corepack is an official tool by Node.js that manages package managers versions
        - name: Setup yarn
          run: corepack enable

        - name: Setup Node.js environment
          uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
          with:
            node-version-file: ".node-version"
            cache: "yarn"

        - name: Install dependencies
          run: yarn

        - name: Create PR for next release
          uses: changesets/action@f13b1baaa620fde937751f5d2c3572b9da32af23 # v1.4.5
          with:
              version: yarn run version
              commit: "Update terraform modules CHANGELOG and prepare next release"
              title: "Push next terraform modules releases"
              createGithubReleases: false
          env:
              GITHUB_TOKEN: ${{ secrets.SPLIT_MODULES_GH_TOKEN }}
