name: OpEx Dashboard Generate

# This reusable workflow wraps the opex-dashboard-generate composite action
# for backwards compatibility and ease of use.
# 
# For new implementations, consider using the action directly:
# uses: pagopa/dx/actions/opex-dashboard-generate@main

on:
  workflow_call:
    inputs:
      config_pattern:
        description: "Glob pattern to find dashboard config files (e.g., 'infra/dashboards/**/config.yaml')"
        type: string
        required: true
      node_version:
        description: "Node.js version to use"
        type: string
        required: false
        default: "22"
      opex_dashboard_version:
        description: "Version of @pagopa/opex-dashboard to use"
        type: string
        required: false
        default: "latest"
      pr_title:
        description: "Title for the generated pull request"
        type: string
        required: false
        default: "chore: update OpEx dashboards"
      pr_body:
        description: "Body for the generated pull request"
        type: string
        required: false
        default: "Automated update of dashboard Terraform from OpenAPI specifications."
      base_branch:
        description: "Base branch for the pull request"
        type: string
        required: false
        default: "main"
      dry_run:
        description: "If true, only detect changes without creating PR"
        type: boolean
        required: false
        default: false
    outputs:
      has_changes:
        description: "Whether any dashboard changes were detected"
        value: ${{ jobs.generate.outputs.has_changes }}
      changed_dashboards:
        description: "JSON array of changed dashboard paths"
        value: ${{ jobs.generate.outputs.changed_dashboards }}
      pr_number:
        description: "Number of the created pull request (if any)"
        value: ${{ jobs.generate.outputs.pr_number }}

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    name: Generate Dashboard Terraform
    runs-on: ubuntu-latest
    # Prevent forks from creating PRs
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    outputs:
      has_changes: ${{ steps.action.outputs.has_changes }}
      changed_dashboards: ${{ steps.action.outputs.changed_dashboards }}
      pr_number: ${{ steps.action.outputs.pr_number }}

    steps:
      - name: Generate OpEx Dashboards
        id: action
        uses: ./actions/opex-dashboard-generate
        with:
          config_pattern: ${{ inputs.config_pattern }}
          node_version: ${{ inputs.node_version }}
          opex_dashboard_version: ${{ inputs.opex_dashboard_version }}
          pr_title: ${{ inputs.pr_title }}
          pr_body: ${{ inputs.pr_body }}
          base_branch: ${{ inputs.base_branch }}
          dry_run: ${{ inputs.dry_run }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
