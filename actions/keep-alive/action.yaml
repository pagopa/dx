name: Keep Alive
description: Action to keep the repository alive. If 55 days have passed since the last commit, it makes an empty push.

inputs:
  bypass:
    description: Force the action to run regardless of the last commit date.
    required: false
    default: false

runs:
  using: composite
  steps:
    - name: Calculate days since last commit
      id: commit_date
      run: |
        LAST_COMMIT_DATE=$(git log -1 --format=%ct)
        echo "Last commit date: $LAST_COMMIT_DATE"

        CURRENT_DATE=$(date +%s)
        echo "Current date: $CURRENT_DATE"

        # Calculate how many days have passed since the last commit
        DIFFERENCE=$(( ($CURRENT_DATE - $LAST_COMMIT_DATE) / 86400 ))
        echo "Days since last commit: $DIFFERENCE"

        echo "days_since_commit=$DIFFERENCE" >> $GITHUB_OUTPUT

    - name: keep-alive
      if: steps.commit_date.outputs.days_since_commit >= 55 || inputs.bypass == 'true'
      shell: bash
      run: |
        git config --local user.email "dx-pagopa-github-bot@pagopa.it"
        git config --local user.name "dx-pagopa-bot"

        git commit --allow-empty -m "Keeping the repository alive" || echo "No changes to commit"
        COMMIT_STATUS=$?

        if [ $COMMIT_STATUS -eq 0 ]; then
          echo "Commit created successfully, attempting to push..."
          git push
        else
          echo "Could not create commit. The repository might be inactive but cannot be kept alive through this method."
          echo "Make sure that the token has write permissions on the repository."
          exit 0
        fi
