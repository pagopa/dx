"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[847],{4718:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>c});var i=t(3309);const r={},s=i.createContext(r);function o(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:n},e.children)}},6441:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"pipelines/drift-detection","title":"Detecting Drift in Infrastructure as Code","description":"The","source":"@site/docs/pipelines/drift-detection.md","sourceDirName":"pipelines","slug":"/pipelines/drift-detection","permalink":"/dx/docs/pipelines/drift-detection","draft":false,"unlisted":false,"editUrl":"https://github.com/pagopa/dx/tree/main/website/docs/pipelines/drift-detection.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1,"sidebar_label":"Detecting Drift in Infrastructure as Code"},"sidebar":"tutorialSidebar","previous":{"title":"Code Review","permalink":"/dx/docs/pipelines/code-review"},"next":{"title":"Keep Alive repositories","permalink":"/dx/docs/pipelines/keep-alive"}}');var r=t(3881),s=t(4718);const o={sidebar_position:1,sidebar_label:"Detecting Drift in Infrastructure as Code"},c="Detecting Drift in Infrastructure as Code",a={},d=[{value:"Usage",id:"usage",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"detecting-drift-in-infrastructure-as-code",children:"Detecting Drift in Infrastructure as Code"})}),"\n",(0,r.jsxs)(n.p,{children:["The\n",(0,r.jsx)(n.a,{href:"https://github.com/pagopa/dx/blob/main/.github/workflows/infra_drift_detection.yml",children:"existing Drift Detection workflow"}),"\nis a GitHub Action that identifies any differences between the Terraform code\nand the current state of the resources stored in the ",(0,r.jsx)(n.code,{children:"*.tfstate"})," file. It also\nverifies if there are any inconsistencies between the state and the resources\ndeployed on Azure."]}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"Slack notifications will be sent if drift is detected."})}),"\n",(0,r.jsxs)(n.p,{children:["You may find more information in this\n",(0,r.jsx)(n.a,{href:"https://www.hashicorp.com/blog/detecting-and-resolving-terraform-drift",children:"article about drift detection"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,r.jsxs)(n.p,{children:["To use the Drift Detection workflow,\n",(0,r.jsx)(n.a,{href:"https://docs.github.com/en/actions/quickstart#creating-your-first-workflow",children:"create a new workflow file"}),"\nin your repository. The file should be named ",(0,r.jsx)(n.code,{children:"infra_drift_detection.yml"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'name: Drift Detection\n\non:\n  workflow_dispatch:\n  schedule:\n    - cron: "00 08 * * *" # Run at 08:00 every day\n\njobs:\n  drift_detection:\n    uses: pagopa/dx/.github/workflows/infra_drift_detection.yml@main\n    name: Drift Detection\n    secrets: inherit\n    with:\n      environment: "dev"\n      base_path: "infra/resources/"\n'})}),"\n",(0,r.jsx)(n.p,{children:"Configuration variables are as follows:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"environment"}),": Specifies the environment where the resources will be\ndeployed. The default value is ",(0,r.jsx)(n.code,{children:"prod"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"base_path"}),": Defines the base path where the script will search for the\nTerraform projects. The default value is ",(0,r.jsx)(n.code,{children:"infra/resources/"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"use_private_agent"}),": Determines whether to use a private agent to run the\n",(0,r.jsx)(n.code,{children:"terraform plan"})," command. The default value is ",(0,r.jsx)(n.code,{children:"false"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["With this configuration, the workflow runs every day at 8:00 AM and checks for\nany drift in the code under ",(0,r.jsx)(n.code,{children:"infra/resources/dev"}),"."]}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsxs)(n.p,{children:["Make sure to configure ",(0,r.jsx)(n.code,{children:"ARM_SUBSCRIPTION_ID"}),", ",(0,r.jsx)(n.code,{children:"ARM_TENANT_ID"}),", and\n",(0,r.jsx)(n.code,{children:"ARM_CLIENT_ID"})," in your GitHub repository secrets for secure authentication."]})}),"\n",(0,r.jsxs)(n.p,{children:["To receive notifications in Slack when drift is detected, set the GitHub secret\n",(0,r.jsx)(n.code,{children:"SLACK_WEBHOOK_URL"}),". The webhook URL is provided by Slack when you create a new\napp. For more information, refer to the\n",(0,r.jsx)(n.a,{href:"https://api.slack.com/messaging/webhooks",children:"Slack documentation"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"An example of a Slack notification is shown below:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-plaintext",children:"    Drift detected! Drift Detection action has failed\n    Drift Detection results:\n    Owner: [COMMIT OWNER NAME]\n    Commit URL: 12345XY\n    Commit message: [COMMIT MESSAGE]\n    Terraform plan results:\n      + Resource to add: 0\n      ~ Resource to change: 1\n      - Resource to destroy: 0\n    Linked Repo: [REPOSITORY LINK]\n"})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}}}]);