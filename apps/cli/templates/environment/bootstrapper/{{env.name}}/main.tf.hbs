{{#each cloudAccountsByCsp.azure}}
{{#if (eq displayName "PROD-IO")}}
module "azure-{{displayName}}_bootstrap" {
  source  = "pagopa-dx/azure-github-environment-bootstrap/azurerm"
  version = "~> 3.0"

  providers = {
    azurerm = azurerm.{{displayName}}
  }

  environment = merge(local.environment, local.azure_accounts.{{displayName}})

  subscription_id = data.azurerm_subscription.PROD_IO.id
  tenant_id       = data.azurerm_subscription.PROD_IO.tenant_id

  entraid_groups = {
    admins_object_id    = data.azuread_group.admins.object_id
    devs_object_id      = data.azuread_group.developers.object_id
    externals_object_id = data.azuread_group.externals.object_id
  }

  terraform_storage_account = {
    name                = "{{@root.terraform.backend.storageAccountName}}"
    resource_group_name = "{{@root.terraform.backend.resourceGroupName}}"
  }

  repository = {
    owner = "{{@root.github.owner}}"
    name  = "{{@root.github.repo}}"
  }

  github_private_runner = {
    container_app_environment_id       = data.azurerm_container_app_environment.runner.id
    container_app_environment_location = data.azurerm_container_app_environment.runner.location
    key_vault = {
      name                = data.azurerm_key_vault.common.name
      resource_group_name = data.azurerm_key_vault.common.resource_group_name
    }
  }

  apim_id                            = data.azurerm_api_management.apim.id
  pep_vnet_id                        = data.azurerm_virtual_network.common.id
  private_dns_zone_resource_group_id = data.azurerm_resource_group.common_weu.id
  nat_gateway_resource_group_id      = data.azurerm_resource_group.common_itn_01.id
  opex_resource_group_id             = data.azurerm_resource_group.dashboards.id

  tags = local.tags
}
{{else}}
module "azure-{{displayName}}_core_values" {
  source  = "pagopa-dx/azure-core-values-exporter/azurerm"
  version = "~> 0.0"

  providers = {
    azurerm = azurerm.{{displayName}}
  }

  core_state = {
    resource_group_name  = "{{@root.terraform.backend.resourceGroupName}}"
    storage_account_name = "{{@root.terraform.backend.storageAccountName}}"
    subscription_id      = "{{@root.terraform.backend.subscriptionId}}"
    container_name       = "terraform-state"
    key                  = "{{@root.env.prefix}}.core.{{@root.env.name}}.tfstate"
  }
}

module "azure-{{displayName}}_bootstrap" {
  source  = "pagopa-dx/azure-github-environment-bootstrap/azurerm"
  version = "~> 3.0"

  providers = {
    azurerm = azurerm.{{displayName}}
  }

  environment = merge(local.environment, local.azure_accounts.{{displayName}})

  subscription_id = module.azure-{{displayName}}_core_values.subscription_id
  tenant_id       = module.azure-{{displayName}}_core_values.tenant_id

  entraid_groups = {
    admins_object_id    = data.azuread_group.admins.object_id
    devs_object_id      = data.azuread_group.developers.object_id
    externals_object_id = data.azuread_group.externals.object_id
  }

  terraform_storage_account = {
    name                = "{{@root.terraform.backend.storageAccountName}}"
    resource_group_name = "{{@root.terraform.backend.resourceGroupName}}"
  }

  repository = {
    owner = "{{@root.github.owner}}"
    name  = "{{@root.github.repo}}"
  }

  github_private_runner = {
    container_app_environment_id       = module.azure-{{displayName}}_core_values.github_runner.environment_id
    container_app_environment_location = local.azure_accounts.{{displayName}}.location
    labels = [
      "{{@root.env.name}}"
    ]
    key_vault = {
      name                = module.azure-{{displayName}}_core_values.common_key_vault.name
      resource_group_name = module.azure-{{displayName}}_core_values.common_key_vault.resource_group_name
    }
  }

  pep_vnet_id                        = module.azure-{{displayName}}_core_values.common_vnet.id
  private_dns_zone_resource_group_id = module.azure-{{displayName}}_core_values.network_resource_group_id
  opex_resource_group_id             = module.azure-{{displayName}}_core_values.opex_resource_group_id

  tags = local.tags
}
{{/if}}
{{/each}}


