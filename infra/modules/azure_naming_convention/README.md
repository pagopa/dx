# DX - Common Variables Validation

This module generates output values that follow the naming conventions used in DX. It takes the following inputs:

- `prefix`: The prefix for the naming convention (e.g., io, dx, ...).
- `env_short`: A short identifier for the environment (e.g., “d”, "p", "u").
- `location`: The Azure region or location (e.g. italynorth, westeurope, ...).
- `domain`: (Optional) The domain name to include in the naming convention.
- `app_name`: The unique name or identifier for the resource (e.g., function, storage, app). This is used to distinguish resources within the same environment or module.
- `instance_number`: A numeric suffix (between 1 and 99) used to differentiate multiple instances of the same resource.

## Outputs

The module generates output values based on whether the configuration targets a single environment or multiple environments.

### Single Environment Outputs

If the module is configured for a single environment, the following outputs are generated:

- `prefix`: Combines prefix, env_short, location_short, optionally including the domain and app_name. The format is:
`prefix-env_short-location_short-domain-app_name` (e.g. `dx-d-itn-test-eg` with domain as test and app_name as eg).
- `suffix`: A map of instance_number values, represented as two-digit strings. Example:

  ```hcl
  {
    "1": "01",
    "2": "02",
    ...
  }
  ```

- `project`: A combination of prefix, env_short, and location_short values. The format is:
`prefix-env_short-location_short`. Example: `dx-d-itn`.
- `name`: A map where resource types serve as keys and the values are resource names.
Resource names follow the format: `prefix-abbreviation-suffix`. The abbreviation is retrieved from the `local.resource_abbreviations` mapping.
  Example:

  ```hcl
  {
    "app_service" = {
      "1" = "dx-d-itn-test-eg-app-01",
      "2" = "dx-d-itn-test-eg-app-02",
      ...
    },
    "blob_storage" = {
      "1" = "dx-d-itn-test-eg-blob-01",
      "2" = "dx-d-itn-test-eg-blob-02",
      ...
    },
    "cosmos_db_nosql" = {
      "1" = "dx-d-itn-test-eg-conmo-01",
      "2" = "dx-d-itn-test-eg-conmo-02",
      ...
    },
    "virtual_network" = {
      "1" = "dx-d-itn-test-eg-vnet-01"
      "2" = "dx-d-itn-test-eg-vnet-02",
      ...
    },
    ...
  }
  ```

### Multi-Environment Outputs

For configurations with multiple environments, the following outputs are generated:

- `prefixes`:  A list of all prefixes, where each combines prefix, env_short, location_short, optionally including domain and app_name. The format is:
`[prefix-env_short-location_short-domain-app_name,..]` (e.g. `dx-d-itn-test-eg` if domain is test and app_name is eg).
- `suffixes`: A map where each key is a prefix, and the value is a map of `instance_number` values as two-digit strings. Example:

  ```hcl
  {
    "dx-d-itn-test-eg" = {
      {
        "1": "01",
        "2": "02",
        ...
      }
    }
  }
  ```

- `projects`: A map where each key is a prefix, and the value is a combination of prefix, env_short, and location_short. Format:
`prefix-env_short-location_short`. E.g.:

  ```hcl
  {
    "dx-d-itn-test-eg" = "dx-d-itn"
  }
  ```

- `name`: A map where resource types serve as keys, and the values are resource names. Resource names follow the format: `prefix-abbreviation-suffix`.
  Example:

  ```hcl
  {
    "app_service" = {
      "1" = "dx-d-itn-test-eg-app-01",
      "2" = "dx-d-itn-test-eg-app-02",
      ...
    },
    "blob_storage" = {
      "1" = "dx-d-itn-test-eg-blob-01",
      "2" = "dx-d-itn-test-eg-blob-02",
      ...
    },
    "cosmos_db_nosql" = {
      "1" = "dx-d-itn-test-eg-conmo-01",
      "2" = "dx-d-itn-test-eg-conmo-02",
      ...
    },
    "virtual_network" = {
      "1" = "dx-d-itn-test-eg-vnet-01"
      "2" = "dx-d-itn-test-eg-vnet-02",
      ...
    },
    ...
  }
  ```

## How it works

This module accepts a list of environments as input and generates corresponding output values.

### Example 1

```hcl
module "naming_convention" {
  source = "git::https://github.com/pagopa/dx-terraform-modules.git//infra/modules/azure_naming_convention?ref=main"

  environments = [
    {
      prefix          = "dx"
      env_short       = "d"
      location        = "italynorth"
      domain          = "test"
      app_name        = "app"
      instance_number = 1
    },
    {
      prefix          = "dx"
      env_short       = "p"
      location        = "italynorth"
      domain          = "test"
      app_name        = "app"
      instance_number = 2
    }
  ]
}
```

To generate the names, you need to use the `output` values generated by this module.
The output is composed of the following values:
> module.naming_convention.names.APP_PREFIX.RESOURCE_TYPE.INSTANCE_NUMBER

Where:

- `APP_PREFIX`: Application prefix (e.g., dx-d-itn-test-app).
- `RESOURCE_TYPE`: Resource type abbreviation (e.g., virtual_network).
- `INSTANCE_NUMBER`: Instance identifier.

Examples:

- `module.naming_convention.names.dx-d-itn-test-app.virtual_network.1` will return `dx-d-itn-test-app-vnet-01`
- `module.naming_convention.names.dx-p-itn-test-app.function_storage_account.2` will return `dxpitntestappstfn02`

### Example 2

For single environments:

```hcl
module "naming_convention" {
  source = "git::https://github.com/pagopa/dx-terraform-modules.git//infra/modules/azure_naming_convention?ref=main"

  environments = [
    {
      prefix          = "dx"
      env_short       = "d"
      location        = "italynorth"
      domain          = "test"
      app_name        = "app"
      instance_number = 3
    }
  ]
}
```

we have only one environemnt. so the output is
> module.naming_convention.name.RESOURCE_TYPE.INSTANCE_NUMBER

Examples:

- `module.naming_convention.names.virtual_network.1` will return `dx-d-itn-test-app-vnet-01`
- `module.naming_convention.names.function_storage_account.2` will return `dxpitntestappstfn02`

<!-- markdownlint-disable -->
<!-- BEGIN_TF_DOCS -->
## Requirements

No requirements.

## Modules

No modules.

## Resources

No resources.

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_environments"></a> [environments](#input\_environments) | List of values which are used to generate resource names and location short names for each environment. They are all mandatory except for domain, which should not be used only in the case of a resource used by multiple domains. | <pre>list(object({<br/>    prefix          = string<br/>    env_short       = string<br/>    location        = string<br/>    domain          = optional(string)<br/>    app_name        = string<br/>    instance_number = number<br/>  }))</pre> | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_name"></a> [name](#output\_name) | n/a |
| <a name="output_names"></a> [names](#output\_names) | n/a |
| <a name="output_prefix"></a> [prefix](#output\_prefix) | n/a |
| <a name="output_prefixes"></a> [prefixes](#output\_prefixes) | n/a |
| <a name="output_project"></a> [project](#output\_project) | n/a |
| <a name="output_projects"></a> [projects](#output\_projects) | n/a |
| <a name="output_suffix"></a> [suffix](#output\_suffix) | n/a |
| <a name="output_suffixes"></a> [suffixes](#output\_suffixes) | n/a |
<!-- END_TF_DOCS -->
